<!DOCTYPE html>
<meta charset="utf-8">
<style>

    body {
        width: 960px;
        margin: auto;
        position: relative;
    }

    svg {
        font: 11px "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    .axis path{
        stroke-width: 0;
    }
    .axis line {
        stroke: lightgray;
        opacity: 0.8;
    }


    .cities {
        fill: none;
        stroke: #aaa;
        stroke-linejoin: round;
        stroke-linecap: round;
        stroke-width: 1.25px;
    }


    .country--hover {
        stroke: #FF0000;
        stroke-width: 1.75px;
    }
    .country--selected {
        stroke: #00FF00;
        stroke-width: 1.75px;
    }
    .country--hoverselected {
        stroke: #000000;
        stroke-width: 1.75px;
    }

    .textbox{  
        width: 60px;                  
        height: 28px;                 
        padding: 2px;             
        font: 12px sans-serif; 
        background: lightsteelblue;   
        border: 0px;      
        border-radius: 8px;           

    }
    .text {
        //background: lightsteelblue;   

        text-anchor: middle;
        text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
    }

    .voronoi path {
        fill: none;
        pointer-events: all;
    }


</style>
<div>
    <!--empty div as otherwise the visualisation is not showing-->
</div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

    var years;
    var margin = {top: 20, right: 30, bottom: 30, left: 40},
    width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

    var formatxAxis = d3.format('04d');

    //array which holds which countries are selected
    var selectedCountries = [];

    var x = d3.scale.linear()
            .range([0, width]);


    var y = d3.scale.linear()
            .range([height, 0]);

    var color = d3.scale.category20();

    var voronoi = d3.geom.voronoi()
            .x(function(d) {
                return x(d.year);
            })
            .y(function(d) {
                return y(d.value);
            })
            .clipExtent([[-margin.left, -margin.top], [width + margin.right, height + margin.bottom]]);

    var line = d3.svg.line()
            .x(function(d) {
                return x(d.year);
            })
            .y(function(d) {
                return y(d.value);
            });

    var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.tsv("internetAdapted.csv", type, function(error, countries) {
        x.domain(d3.extent(years));
        y.domain([0, d3.max(countries, function(c) {
                return d3.max(c.values, function(d) {
                    return d.value;
                });
            })]).nice();

        svg.append("g")
                .attr("class", "axis axis--x")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.svg.axis()
                        .scale(x)
                        .orient("bottom")
                        .tickSize(-height, 0, 0)
                        .tickFormat(formatxAxis));


        svg.append("g")
                .attr("class", "axis axis--y")
                .call(d3.svg.axis()
                        .scale(y)
                        .orient("left")
                        .tickSize(-width, 0, 0)
                        .ticks(10, "%"))
                .append("text")
                .attr("x", 4)
                .attr("dy", ".32em")
                .style("font-weight", "bold")
                .text("Internet connectivity percentage");

        svg.append("g")
                .attr("class", "cities")
                .selectAll("path")
                .data(countries)
                .enter().append("path")
                .attr("d", function(d) {
                    d.line = this;
                    return line(d.values);
                });

        var focus = svg.append("g")
                .attr("transform", "translate(-100,-100)")
                .attr("class", "focus");

        focus.append("circle")
                .attr("r", 3.5);
        focus.append("text")
                .attr("y", -10);
        focus.append("textbox")
                .attr("y", -20)
                .attr("width", "20px")
                .attr("height", "20px");

        var voronoiGroup = svg.append("g")
                .attr("class", "voronoi");

        voronoiGroup.selectAll("path")
                .data(voronoi(d3.nest()
                        .key(function(d) {
                            return x(d.year) + "," + y(d.value);
                        })
                        .rollup(function(v) {
                            return v[0];
                        })
                        .entries(d3.merge(countries.map(function(d) {
                            return d.values;
                        })))
                        .map(function(d) {
                            return d.values;
                        })))
                .enter().append("path")
                .attr("d", function(d) {
                    if (d !== undefined)
                    {
                        return "M" + d.join("L") + "Z";
                    }
                })
                .datum(function(d) {
                    if (d !== undefined)
                    {
                        return d.point;
                    }
                })
                .on("mouseover", mouseover)
                .on("mouseout", mouseout)
                .on("mousedown", mouseclick);

        function mouseover(d) {
            var countryName = d.country.countryName;
            if (countainsCountry(countryName))
            {
                //reset color
                d3.select(d.country.line).classed("country--hoverselected", true);
                d3.select(d.country.line).classed("country--hover", false);
                d3.select(d.country.line).classed("country--selected", false);
            } else {
                d3.select(d.country.line).classed("country--hoverselected", false);
                d3.select(d.country.line).classed("country--hover", true);
                d3.select(d.country.line).classed("country--selected", false);
            }

            focus.attr("transform", "translate(" + x(d.year) + "," + y(d.value) + ")");
            focus.select("text").html("country: " + countryName + "\r\n" +
                    "Year " + d.originalYear.substring(0, 4) + "\r\n" +
                    "internetConnectity: " + (Math.round(d.originalValue * 100) / 100) + "%");
            //TODO Get textBox to work so we display this properly
        }
        function mouseout(d) {
            var countryName = d.country.countryName;
            d3.select(d.country.line).classed("country--hover", false);
            if (countainsCountry(countryName))
            {
                //TODO Set the colors differently
                //reset color
                d3.select(d.country.line).classed("country--hoverselected", false);
                d3.select(d.country.line).classed("country--hover", false);
                d3.select(d.country.line).classed("country--selected", true);
            } else {
                //TODO Set the colors differently
                d3.select(d.country.line).classed("country--hoverselected", false);
                d3.select(d.country.line).classed("country--hover", false);
                d3.select(d.country.line).classed("country--selected", false);
            }

            focus.attr("transform", "translate(-100,-100)");
        }


        function mouseclick(d) {
            console.log(1);
            console.log(d3.select("path"));
            var countryName = d.country.countryName;
            if (countainsCountry(countryName))
            {
                //country was no in array yet, so we select it
                console.log("not contained");
                removeSelectedCountry(countryName)
            } else {
                //country was in array, so we remove it
                console.log("Contained");
                addSelectedCountry(countryName);
            }
        }
        function removeSelectedCountry(countryName)
        {
            var index = selectedCountries.indexOf(countryName);
            selectedCountries.splice(index, 1);

            var country = findCountry(countryName);
            //color the line
            d3.select(country.line).classed("country--selected", false);
        }

        function addSelectedCountry(countryName)
        {
            selectedCountries.push(countryName);

            var country = findCountry(countryName);
            //color the line
            d3.select(country.line).classed("country--selected", true);
        }

        function findCountry(countryName)
        {
            var path = d3.select("g.cities").selectAll("path").filter(function(d) {
                if (d.countryName === countryName)
                {
                    return d;
                }
            })[0][0];
            var country = path.__data__;
            return country;
        }

        function countainsCountry(countryName)
        {
            var index = selectedCountries.indexOf(countryName);
            if (index === -1)
            {
                return false;
            } else {
                return true;
            }
        }
    });

    function type(d, i) {
        years = Object.keys(d).filter(Number);
        var country = {
            countryName: d.countryName,
            values: null
        };
        country.values = years.map(function(y) {
            return {
                country: country,
                year: y,
                value: Math.abs(d[y] / 100),
                originalYear: Math.floor(y) + ".0",
                originalValue: d[Math.floor(y) + ".0"] / 100
            };
        });
        return country;
    }

</script>
